<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>nastajus GitHub Archive</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Oswald:wght@300;400;600&family=Crimson+Pro:wght@400;600&display=swap');

    :root {
      --bg: #0f140f;
      --bg-glow: #16291b;
      --panel: #141b14;
      --panel-2: #1b251b;
      --ink: #e8f1e8;
      --muted: #a7b3a6;
      --accent: #9ad66f;
      --accent-2: #f1c27a;
      --private: #f08b6a;
      --grid-empty: #223022;
      --grid-1: #2f5e3b;
      --grid-2: #3c7b3f;
      --grid-3: #59a94f;
      --grid-4: #7bd354;
      --grid-1-gmu: #7a2a2a;
      --grid-2-gmu: #a03a3a;
      --grid-3-gmu: #c44b4b;
      --grid-4-gmu: #e55c5c;
      --cell: 14px;
      --gap: 4px;
      --radius: 14px;
      --shadow: 0 10px 40px rgba(0, 0, 0, 0.35);
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Crimson Pro", serif;
      color: var(--ink);
      background:
        radial-gradient(1200px 400px at 10% -10%, rgba(154, 214, 111, 0.12), transparent),
        radial-gradient(900px 500px at 90% 0%, rgba(241, 194, 122, 0.12), transparent),
        linear-gradient(180deg, var(--bg), var(--bg-glow) 60%, #0b100b 100%);
      min-height: 100vh;
    }

    header {
      padding: 36px 24px 12px;
      max-width: 1200px;
      margin: 0 auto;
      animation: rise 700ms ease-out;
    }

    h1 {
      font-family: "Oswald", sans-serif;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      font-size: clamp(2rem, 3vw, 3.2rem);
      margin: 0 0 8px;
    }

    p.lead {
      margin: 0;
      color: var(--muted);
      font-size: 1.1rem;
      max-width: 800px;
    }

    nav {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 18px;
    }

    nav a {
      text-decoration: none;
      color: var(--ink);
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid rgba(255, 255, 255, 0.08);
      font-family: "Oswald", sans-serif;
      font-size: 0.9rem;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      transition: transform 200ms ease, background 200ms ease;
    }

    nav a:hover {
      transform: translateY(-2px);
      background: rgba(154, 214, 111, 0.2);
    }

    main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 12px 24px 64px;
      display: grid;
      gap: 24px;
    }

    section {
      background: var(--panel);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    section h2 {
      font-family: "Oswald", sans-serif;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      margin: 0 0 12px;
      font-size: 1.4rem;
    }

    .legend {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--muted);
      font-size: 0.9rem;
      margin-bottom: 12px;
    }

    .legend span {
      width: 12px;
      height: 12px;
      border-radius: 3px;
      display: inline-block;
    }

    .heatmap {
      display: grid;
      gap: 24px;
    }

    .heatmap-controls {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }

    .filter-pill {
      font-family: "Oswald", sans-serif;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      font-size: 0.8rem;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(255, 255, 255, 0.06);
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .filter-pill strong {
      color: var(--accent-2);
      font-weight: 600;
    }

    .filter-pill .origin-tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-left: 6px;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.7rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .origin-tag.gmu {
      background: rgba(229, 92, 92, 0.2);
      color: #ffb3b3;
    }

    .origin-tag.user {
      background: rgba(123, 211, 84, 0.2);
      color: #b9f2a2;
    }

    .filter-clear {
      border: none;
      background: #ffe58a;
      color: #1a1f1a;
      padding: 6px 12px;
      border-radius: 999px;
      cursor: pointer;
      font-family: "Oswald", sans-serif;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      font-size: 0.8rem;
      transition: transform 150ms ease, background 150ms ease;
    }

    .filter-clear:hover {
      transform: translateY(-1px);
      background: #ffdd5f;
    }

    .year-block {
      background: var(--panel-2);
      border-radius: 12px;
      padding: 16px;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .year-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .year-header h3 {
      font-family: "Oswald", sans-serif;
      margin: 0;
      font-size: 1.1rem;
      letter-spacing: 0.05em;
    }

    .year-total {
      font-family: "Oswald", sans-serif;
      letter-spacing: 0.04em;
      font-size: 0.9rem;
      color: var(--muted);
      cursor: help;
    }

    .year-grid {
      display: grid;
      grid-auto-flow: column;
      grid-template-rows: repeat(7, var(--cell));
      gap: var(--gap);
      align-content: start;
    }

    .day-cell {
      width: var(--cell);
      height: var(--cell);
      border-radius: 3px;
      background: var(--grid-empty);
      cursor: pointer;
      transition: transform 120ms ease, box-shadow 120ms ease;
    }

    .day-cell:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.35);
    }

    .day-cell.level-1 { background: var(--grid-1); }
    .day-cell.level-2 { background: var(--grid-2); }
    .day-cell.level-3 { background: var(--grid-3); }
    .day-cell.level-4 { background: var(--grid-4); }
    .day-cell.level-1.gmu { background: var(--grid-1-gmu); }
    .day-cell.level-2.gmu { background: var(--grid-2-gmu); }
    .day-cell.level-3.gmu { background: var(--grid-3-gmu); }
    .day-cell.level-4.gmu { background: var(--grid-4-gmu); }
    .day-cell.outside { background: #1a231a; opacity: 0.35; cursor: default; }
    .day-cell.flash {
      animation: pulse 1.2s ease;
      outline: 2px solid var(--accent-2);
      outline-offset: 2px;
    }

    .heatmap.filtered .day-cell {
      background: #1a1f1a;
      opacity: 0.5;
    }

    .heatmap.filtered .day-cell.outside {
      opacity: 0.2;
    }

    .heatmap.filtered .day-cell.highlight {
      background: #f6e96b;
      opacity: 1;
      outline: 2px solid #ffe58a;
      outline-offset: 2px;
      animation: glow 1.4s ease-in-out infinite;
    }

    .heatmap.filtered .day-cell.highlight:hover {
      animation: glow 0.8s ease-in-out infinite;
    }

    .heatmap.origin-filter .day-cell {
      background: #1a1f1a;
      opacity: 0.5;
    }

    .heatmap.origin-filter .day-cell.origin-highlight {
      opacity: 1;
      outline: 2px solid rgba(255, 255, 255, 0.45);
      outline-offset: 2px;
    }

    .heatmap.day-focus .day-cell {
      background: #1a1f1a;
      opacity: 0.45;
    }

    .heatmap.day-focus .day-cell.outside {
      opacity: 0.2;
    }

    .heatmap.day-focus .day-cell.focus-highlight {
      opacity: 1;
      outline: 2px solid rgba(255, 255, 255, 0.5);
      outline-offset: 2px;
    }

    .details {
      display: grid;
      gap: 12px;
    }

    .details .panel {
      background: rgba(0, 0, 0, 0.25);
      border-radius: 12px;
      padding: 14px;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .details h4 {
      margin: 0 0 8px;
      font-family: "Oswald", sans-serif;
      letter-spacing: 0.04em;
    }

    .detail-title {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-family: "Oswald", sans-serif;
      letter-spacing: 0.06em;
      font-size: 1.05rem;
      text-transform: uppercase;
      color: var(--accent);
      text-decoration: none;
    }

    .commit-list {
      max-height: 360px;
      overflow-y: auto;
      padding-right: 8px;
    }

    .commit-item {
      padding: 10px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
    }

    .commit-item:last-child { border-bottom: none; }

    .repo-group {
      padding: 10px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
    }

    .repo-group:last-child { border-bottom: none; }

    .repo-title {
      font-family: "Oswald", sans-serif;
      font-size: 1.05rem;
      letter-spacing: 0.04em;
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }

    .repo-filter {
      background: transparent;
      border: none;
      padding: 0;
      margin: 0;
      color: var(--ink);
      font-family: "Oswald", sans-serif;
      font-size: 1.05rem;
      letter-spacing: 0.04em;
      cursor: pointer;
    }

    .repo-filter:hover {
      color: var(--accent-2);
    }

    .tooltip {
      position: absolute;
      z-index: 20;
      background: rgba(15, 20, 15, 0.95);
      color: var(--ink);
      border: 1px solid rgba(255, 255, 255, 0.08);
      padding: 10px 12px;
      border-radius: 10px;
      font-size: 0.85rem;
      max-width: 260px;
      pointer-events: none;
      box-shadow: var(--shadow);
      opacity: 0;
      transform: translateY(6px);
      transition: opacity 120ms ease, transform 120ms ease;
    }

    .tooltip.visible {
      opacity: 1;
      transform: translateY(0);
    }

    .tooltip ul {
      margin: 6px 0 0;
      padding-left: 18px;
    }

    .tooltip li {
      margin: 2px 0;
    }

    .year-tooltip {
      position: absolute;
      z-index: 25;
      background: rgba(15, 20, 15, 0.95);
      color: var(--ink);
      border: 1px solid rgba(255, 255, 255, 0.08);
      padding: 10px 12px;
      border-radius: 10px;
      font-size: 0.85rem;
      pointer-events: none;
      box-shadow: var(--shadow);
      opacity: 0;
      transform: translateY(6px);
      transition: opacity 120ms ease, transform 120ms ease;
    }

    .year-tooltip.visible {
      opacity: 1;
      transform: translateY(0);
    }

    .year-tooltip ul {
      list-style: none;
      padding: 0;
      margin: 6px 0 0;
      display: grid;
      gap: 6px;
    }

    .year-tooltip li {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .day-popup {
      position: absolute;
      z-index: 30;
      background: rgba(20, 27, 20, 0.98);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      padding: 12px;
      min-width: 220px;
      box-shadow: var(--shadow);
    }

    .day-popup h4 {
      margin: 0 0 8px;
      font-family: "Oswald", sans-serif;
      letter-spacing: 0.04em;
    }

    .day-popup ul {
      list-style: none;
      padding: 0;
      margin: 0 0 10px;
      display: grid;
      gap: 6px;
    }

    .day-popup li {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
    }

    .day-popup button.project-link {
      border: none;
      background: transparent;
      color: var(--ink);
      font-family: "Oswald", sans-serif;
      letter-spacing: 0.03em;
      cursor: pointer;
      padding: 0;
    }

    .day-popup button.project-link:hover {
      color: var(--accent-2);
    }

    .swatch {
      width: 12px;
      height: 12px;
      border-radius: 3px;
      display: inline-block;
      border: 1px solid rgba(255, 255, 255, 0.35);
    }

    .popup-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .popup-actions button {
      border: none;
      background: rgba(255, 255, 255, 0.08);
      color: var(--ink);
      padding: 6px 10px;
      border-radius: 999px;
      cursor: pointer;
      font-family: "Oswald", sans-serif;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      font-size: 0.75rem;
    }

    .popup-actions button.primary {
      background: #f6e96b;
      color: #1a1f1a;
    }

    .commit-subject {
      font-size: 1rem;
      text-decoration: none;
      color: var(--ink);
    }

    .commit-subject:hover {
      color: var(--accent);
    }

    .commit-body {
      color: var(--muted);
      font-size: 0.9rem;
      margin-top: 6px;
      white-space: pre-wrap;
      overflow: hidden;
      display: -webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: 3;
      cursor: pointer;
    }

    .commit-body.expanded {
      -webkit-line-clamp: unset;
    }

    .commit-meta {
      color: var(--muted);
      font-size: 0.9rem;
    }

    .tag {
      font-family: "Oswald", sans-serif;
      font-size: 0.75rem;
      padding: 2px 6px;
      border-radius: 999px;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }

    .tag.private {
      background: rgba(240, 139, 106, 0.2);
      color: var(--private);
      border: 1px solid rgba(240, 139, 106, 0.4);
    }

    .repo-grid {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    }

    .repo-card {
      background: rgba(0, 0, 0, 0.22);
      border-radius: 12px;
      padding: 12px;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .repo-card h3 {
      margin: 0 0 6px;
      font-family: "Oswald", sans-serif;
      font-size: 1rem;
      letter-spacing: 0.04em;
    }

    .repo-title-line {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .origin-label {
      font-family: "Oswald", sans-serif;
      font-size: 0.7rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.18);
      cursor: pointer;
    }

    .origin-label.gmu {
      color: #ffb3b3;
      background: rgba(229, 92, 92, 0.25);
    }

    .origin-label.user {
      color: #b9f2a2;
      background: rgba(123, 211, 84, 0.2);
    }

    .repo-links {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .repo-links a {
      text-decoration: none;
      color: var(--accent);
      font-size: 0.9rem;
    }

    .data-links a {
      color: var(--accent-2);
      text-decoration: none;
      font-family: "Oswald", sans-serif;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      font-size: 0.85rem;
    }

    .stagger {
      animation: fadeUp 500ms ease forwards;
    }

    @keyframes rise {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(6px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 rgba(241, 194, 122, 0); }
      50% { box-shadow: 0 0 20px rgba(241, 194, 122, 0.45); }
      100% { box-shadow: 0 0 0 rgba(241, 194, 122, 0); }
    }

    @keyframes glow {
      0% { box-shadow: 0 0 0 rgba(246, 233, 107, 0.1); }
      50% { box-shadow: 0 0 16px rgba(246, 233, 107, 0.6); }
      100% { box-shadow: 0 0 0 rgba(246, 233, 107, 0.1); }
    }

    @media (max-width: 780px) {
      nav { justify-content: center; }
      section { padding: 16px; }
      .details { grid-template-columns: 1fr; }
      .year-grid { overflow-x: auto; padding-bottom: 6px; }
    }
  </style>
</head>
<body>
  <header>
    <h1>nastajus GitHub Archive</h1>
    <p class="lead">All repositories (public + private) cloned locally, with commit history aggregated into a single calendar heatmap. Click any day to inspect commits and jump to the repo locally or on GitHub.</p>
    <nav>
      <a href="#heatmap">Heatmap</a>
      <a href="#details">Day Details</a>
      <a href="#repos">Repositories</a>
      <a href="#forks">Forks</a>
      <a href="#data">Raw Data</a>
    </nav>
  </header>

  <main>
    <section id="heatmap">
      <h2>All Years Heatmap</h2>
      <div class="heatmap-controls">
        <div id="filter-pill" class="filter-pill" style="display: none;">
          Filtered: <strong id="filter-name"></strong>
        </div>
        <button id="filter-clear" class="filter-clear" style="display: none;">Clear filter</button>
      </div>
      <div class="legend">
        <span style="background: var(--grid-empty);"></span> none
        <span style="background: var(--grid-1);"></span> low
        <span style="background: var(--grid-2);"></span> medium
        <span style="background: var(--grid-3);"></span> high
        <span style="background: var(--grid-4);"></span> intense
        <span style="background: var(--grid-2-gmu);"></span> GMU
      </div>
      <div id="heatmap-container" class="heatmap"></div>
    </section>

    <section id="details">
      <h2>Day Details</h2>
      <div class="details">
        <div class="panel">
          <a id="detail-title" class="detail-title" href="#heatmap">Select a day</a>
          <div id="detail-meta" class="commit-meta">Click a green square to view commits.</div>
        </div>
        <div class="panel">
          <h4>Commits</h4>
          <div id="commit-list" class="commit-list">No day selected.</div>
        </div>
      </div>
    </section>

    <section id="repos">
      <h2>Repositories</h2>
      <div class="commit-meta">Forked repositories are excluded from the heatmap.</div>
      <div id="repo-grid" class="repo-grid"></div>
    </section>

    <section id="forks">
      <h2>Forks (Excluded from Heatmap)</h2>
      <div id="fork-grid" class="repo-grid"></div>
    </section>

    <section id="data">
      <h2>Raw Data</h2>
      <div class="data-links">
        <a href="data/commits.json">commits.json</a> |
        <a href="data/commits.csv">commits.csv</a> |
        <a href="data/repos.json">repos.json</a> |
        <a href="data/repos.csv">repos.csv</a>
      </div>
    </section>

    <section id="legend-info">
      <h2>Heatmap Scale</h2>
      <div class="commit-meta">
        The color scale is dynamic: each day is bucketed into 4 levels based on its total commit
        count relative to the maximum commit count found across all days in the dataset. GMU days
        use the same global scale as personal days. Year totals include both personal and GMU commits.
      </div>
      <div id="scale-info" class="commit-meta" style="margin-top: 8px;"></div>
    </section>
  </main>

  <div id="tooltip" class="tooltip"></div>
  <div id="day-popup" class="day-popup" style="display: none;"></div>
  <div id="year-tooltip" class="year-tooltip"></div>

  <script src="data/commits.js"></script>
  <script src="data/repos.js"></script>
  <script>
    const commits = window.COMMITS_DATA || [];
    const repos = window.REPOS_DATA || [];

    const commitMap = new Map();
    const counts = [];
    const repoDateMap = new Map();
    const repoByDate = new Map();
    const originByDate = new Map();
    const originCountByDate = new Map();
    const originCountByYear = new Map();
    const repoOriginMap = new Map();
    let currentRepoFilter = null;
    let currentOriginFilter = null;
    let dayFocus = null;
    let dayFocusProjects = [];
    let dayFocusColors = new Map();
    let projectColors = new Map();
    let colorConflicts = false;

    for (const c of commits) {
      const key = c.commit_date_only;
      if (!commitMap.has(key)) commitMap.set(key, []);
      commitMap.get(key).push(c);

      if (!repoDateMap.has(c.repo_name)) repoDateMap.set(c.repo_name, new Set());
      repoDateMap.get(c.repo_name).add(c.commit_date_only);

      if (!repoByDate.has(key)) repoByDate.set(key, new Set());
      repoByDate.get(key).add(c.repo_name);

      const originLabel = c.repo_origin_label || 'Nastajus';
      if (!originByDate.has(key)) originByDate.set(key, new Set());
      originByDate.get(key).add(originLabel);

      if (!originCountByDate.has(key)) originCountByDate.set(key, new Map());
      const countMap = originCountByDate.get(key);
      countMap.set(originLabel, (countMap.get(originLabel) || 0) + 1);

      const yearKey = key.slice(0, 4);
      if (!originCountByYear.has(yearKey)) originCountByYear.set(yearKey, new Map());
      const yearMap = originCountByYear.get(yearKey);
      yearMap.set(originLabel, (yearMap.get(originLabel) || 0) + 1);

      if (!repoOriginMap.has(c.repo_name)) repoOriginMap.set(c.repo_name, originLabel);
    }

    for (const [date, list] of commitMap.entries()) {
      counts.push(list.length);
    }

    const maxCount = counts.length ? Math.max(...counts) : 0;
    let currentDateStr = null;
    const heatmapContainer = document.getElementById('heatmap-container');
    const filterPill = document.getElementById('filter-pill');
    const filterName = document.getElementById('filter-name');
    const filterClear = document.getElementById('filter-clear');
    const tooltip = document.getElementById('tooltip');
    const dayPopup = document.getElementById('day-popup');
    const yearTooltip = document.getElementById('year-tooltip');
    const palette = [
      '#f6e96b', '#ffb347', '#ff7aa2', '#c97cff', '#7aa2ff', '#5dd4c3',
      '#7bd354', '#f29e4c', '#f94144', '#b8f2e6', '#f1c27a', '#a5a6f6'
    ];

    projectColors = buildProjectColorMap();

    function applyRepoFilter(repoName) {
      clearOriginFilter();
      clearDayFocus();
      currentRepoFilter = repoName;
      const dates = repoDateMap.get(repoName) || new Set();
      filterName.textContent = repoName;
      filterName.appendChild(buildOriginTag(repoName));
      filterPill.style.display = 'inline-flex';
      filterClear.style.display = 'inline-flex';
      heatmapContainer.classList.add('filtered');

      document.querySelectorAll('.day-cell').forEach((cell) => {
        if (cell.classList.contains('outside')) return;
        if (dates.has(cell.dataset.date)) {
          cell.classList.add('highlight');
        } else {
          cell.classList.remove('highlight');
        }
      });

      if (dates.size > 0) {
        const earliest = Array.from(dates).sort()[0];
        const year = earliest.slice(0, 4);
        const yearBlock = document.querySelector(`.year-block[data-year='${year}']`);
        if (yearBlock) {
          yearBlock.scrollIntoView({ behavior: 'smooth', block: 'center' });
        } else {
          document.getElementById('heatmap').scrollIntoView({ behavior: 'smooth' });
        }
      }
    }

    function clearRepoFilter() {
      currentRepoFilter = null;
      filterPill.style.display = 'none';
      filterClear.style.display = 'none';
      filterName.innerHTML = '';
      heatmapContainer.classList.remove('filtered');
      document.querySelectorAll('.day-cell.highlight').forEach((cell) => {
        cell.classList.remove('highlight');
      });
    }

    function applyOriginFilter(originLabel) {
      if (currentOriginFilter === originLabel) {
        clearOriginFilter();
        return;
      }
      clearRepoFilter();
      clearDayFocus();
      currentOriginFilter = originLabel;
      filterName.textContent = 'Origin';
      const tag = document.createElement('span');
      tag.className = `origin-tag ${originLabel === 'GMU' ? 'gmu' : 'user'}`;
      tag.textContent = originLabel;
      filterName.appendChild(tag);
      filterPill.style.display = 'inline-flex';
      filterClear.style.display = 'inline-flex';
      heatmapContainer.classList.add('origin-filter');

      document.querySelectorAll('.day-cell').forEach((cell) => {
        if (cell.classList.contains('outside')) return;
        const origins = originByDate.get(cell.dataset.date);
        if (origins && origins.has(originLabel)) {
          cell.classList.add('origin-highlight');
        } else {
          cell.classList.remove('origin-highlight');
        }
      });

      document.querySelectorAll('.repo-card').forEach((card) => {
        const origin = card.dataset.origin;
        card.style.display = origin === originLabel ? '' : 'none';
      });
    }

    function clearOriginFilter() {
      currentOriginFilter = null;
      heatmapContainer.classList.remove('origin-filter');
      filterPill.style.display = 'none';
      filterClear.style.display = 'none';
      filterName.innerHTML = '';
      document.querySelectorAll('.day-cell.origin-highlight').forEach((cell) => {
        cell.classList.remove('origin-highlight');
      });
      document.querySelectorAll('.repo-card').forEach((card) => {
        card.style.display = '';
      });
    }

    function buildOriginTag(repoName) {
      const origin = repoOriginMap.get(repoName) || 'Nastajus';
      const tag = document.createElement('span');
      tag.className = `origin-tag ${origin === 'GMU' ? 'gmu' : 'user'}`;
      tag.textContent = origin;
      return tag;
    }

    function buildProjectColorMap() {
      const adjacency = new Map();
      for (const projects of repoByDate.values()) {
        const arr = Array.from(projects);
        for (let i = 0; i < arr.length; i++) {
          const a = arr[i];
          if (!adjacency.has(a)) adjacency.set(a, new Set());
          for (let j = i + 1; j < arr.length; j++) {
            const b = arr[j];
            if (!adjacency.has(b)) adjacency.set(b, new Set());
            adjacency.get(a).add(b);
            adjacency.get(b).add(a);
          }
        }
      }

      const projects = Array.from(adjacency.keys());
      projects.sort((a, b) => (adjacency.get(b)?.size || 0) - (adjacency.get(a)?.size || 0));

      const colors = new Map();
      colorConflicts = false;

      for (const project of projects) {
        const used = new Set();
        for (const neighbor of adjacency.get(project) || []) {
          if (colors.has(neighbor)) used.add(colors.get(neighbor));
        }
        const available = palette.find((c) => !used.has(c));
        if (available) {
          colors.set(project, available);
        } else {
          colors.set(project, palette[projects.indexOf(project) % palette.length]);
          colorConflicts = true;
        }
      }
      return colors;
    }

    function setDayFocus(dateStr) {
      clearRepoFilter();
      tooltip.classList.remove('visible');
      dayFocus = dateStr;
      const projectSet = repoByDate.get(dateStr) || new Set();
      dayFocusProjects = Array.from(projectSet);
      dayFocusColors = new Map();
      dayFocusProjects.forEach((name) => {
        dayFocusColors.set(name, projectColors.get(name) || palette[0]);
      });
      heatmapContainer.classList.add('day-focus');

      document.querySelectorAll('.day-cell').forEach((cell) => {
        if (cell.classList.contains('outside')) return;
        const dateProjects = repoByDate.get(cell.dataset.date);
        if (!dateProjects) {
          cell.classList.remove('focus-highlight');
          cell.style.background = '';
          return;
        }
        const matches = Array.from(dateProjects).filter((p) => dayFocusColors.has(p));
        if (matches.length === 0) {
          cell.classList.remove('focus-highlight');
          cell.style.background = '';
          return;
        }
        cell.classList.add('focus-highlight');
        if (matches.length === 1) {
          cell.style.background = dayFocusColors.get(matches[0]);
        } else {
          const colors = matches.map((p) => dayFocusColors.get(p));
          cell.style.background = `conic-gradient(${colors.join(', ')})`;
        }
      });
    }

    function clearDayFocus() {
      dayFocus = null;
      dayFocusProjects = [];
      dayFocusColors = new Map();
      heatmapContainer.classList.remove('day-focus');
      document.querySelectorAll('.day-cell.focus-highlight').forEach((cell) => {
        cell.classList.remove('focus-highlight');
        cell.style.background = '';
      });
      hideDayPopup();
    }

    function showDayPopup(cell, dateStr) {
      const projects = Array.from(repoByDate.get(dateStr) || []);
      dayPopup.innerHTML = '';
      if (projects.length === 0) {
        dayPopup.style.display = 'none';
        return;
      }
      dayPopup.style.display = 'block';

      const title = document.createElement('h4');
      title.textContent = `Projects on ${dateStr}`;
      dayPopup.appendChild(title);

      const list = document.createElement('ul');
      projects.forEach((project) => {
        const li = document.createElement('li');
        const swatch = document.createElement('span');
        swatch.className = 'swatch';
        swatch.style.background = dayFocusColors.get(project) || '#f6e96b';
        li.appendChild(swatch);
        const label = document.createElement('button');
        label.type = 'button';
        label.className = 'project-link';
        label.textContent = project;
        label.addEventListener('click', () => {
          applyRepoFilter(project);
          hideDayPopup();
        });
        li.appendChild(label);
        list.appendChild(li);
      });
      dayPopup.appendChild(list);

      const hint = document.createElement('div');
      hint.className = 'commit-meta';
      hint.textContent = 'Click a project to filter and view its commits.';
      dayPopup.appendChild(hint);

      if (colorConflicts) {
        const note = document.createElement('div');
        note.className = 'commit-meta';
        note.textContent = 'Note: limited palette may reuse colors on non-overlapping projects.';
        dayPopup.appendChild(note);
      }

      const actions = document.createElement('div');
      actions.className = 'popup-actions';
      const view = document.createElement('button');
      view.type = 'button';
      view.className = 'primary';
      view.textContent = 'View all commits';
      view.addEventListener('click', () => {
        renderDetails(dateStr);
        location.hash = '#details';
        document.getElementById('details').scrollIntoView({ behavior: 'smooth' });
        hideDayPopup();
      });
      const clear = document.createElement('button');
      clear.type = 'button';
      clear.textContent = 'Clear focus';
      clear.addEventListener('click', () => {
        clearDayFocus();
      });
      actions.appendChild(view);
      actions.appendChild(clear);
      dayPopup.appendChild(actions);

      const rect = cell.getBoundingClientRect();
      const top = window.scrollY + rect.top - dayPopup.offsetHeight - 12;
      const left = window.scrollX + rect.left + rect.width + 12;
      dayPopup.style.top = `${Math.max(top, window.scrollY + 16)}px`;
      dayPopup.style.left = `${Math.min(left, window.scrollX + window.innerWidth - 260)}px`;
    }

    function hideDayPopup() {
      dayPopup.style.display = 'none';
      dayPopup.innerHTML = '';
    }

    function levelFor(count) {
      if (count === 0) return 0;
      if (maxCount === 0) return 0;
      const level = Math.ceil((count / maxCount) * 4);
      return Math.min(4, Math.max(1, level));
    }

    function getLevelRanges() {
      if (maxCount === 0) return [];
      const t1 = Math.floor(maxCount / 4);
      const t2 = Math.floor(maxCount / 2);
      const t3 = Math.floor((3 * maxCount) / 4);
      return [
        { level: 1, min: 1, max: Math.max(1, t1) },
        { level: 2, min: Math.max(1, t1 + 1), max: Math.max(t1 + 1, t2) },
        { level: 3, min: Math.max(1, t2 + 1), max: Math.max(t2 + 1, t3) },
        { level: 4, min: Math.max(1, t3 + 1), max: maxCount }
      ];
    }

    function buildYearBlock(year) {
      const container = document.createElement('div');
      container.className = 'year-block stagger';
      container.dataset.year = year;

      const header = document.createElement('div');
      header.className = 'year-header';
      const title = document.createElement('h3');
      title.textContent = year;
      const total = document.createElement('div');
      total.className = 'year-total';
      const yearCount = Array.from(commitMap.keys())
        .filter(d => d.startsWith(year + '-'))
        .reduce((sum, d) => sum + commitMap.get(d).length, 0);
      total.textContent = yearCount + ' commits';
      total.addEventListener('mouseenter', (event) => {
        const yearMap = originCountByYear.get(String(year)) || new Map();
        if (yearMap.size < 2) {
          yearTooltip.classList.remove('visible');
          return;
        }
        const list = document.createElement('ul');
        yearMap.forEach((value, key) => {
          const li = document.createElement('li');
          const swatch = document.createElement('span');
          swatch.className = 'swatch';
          swatch.style.background = key === 'GMU' ? 'var(--grid-3-gmu)' : 'var(--grid-3)';
          li.appendChild(swatch);
          const label = document.createElement('span');
          label.textContent = `${key}: ${value}`;
          li.appendChild(label);
          list.appendChild(li);
        });
        yearTooltip.innerHTML = '';
        const title = document.createElement('div');
        title.textContent = `Origin breakdown (${year})`;
        yearTooltip.appendChild(title);
        yearTooltip.appendChild(list);
        yearTooltip.classList.add('visible');
        yearTooltip.style.top = `${event.pageY + 12}px`;
        yearTooltip.style.left = `${event.pageX + 12}px`;
      });
      total.addEventListener('mousemove', (event) => {
        if (!yearTooltip.classList.contains('visible')) return;
        yearTooltip.style.top = `${event.pageY + 12}px`;
        yearTooltip.style.left = `${event.pageX + 12}px`;
      });
      total.addEventListener('mouseleave', () => {
        yearTooltip.classList.remove('visible');
      });
      header.appendChild(title);
      header.appendChild(total);

      const grid = document.createElement('div');
      grid.className = 'year-grid';

      const start = new Date(Date.UTC(year, 0, 1));
      const end = new Date(Date.UTC(year, 11, 31));
      const startDay = start.getUTCDay();
      const gridStart = new Date(start);
      gridStart.setUTCDate(start.getUTCDate() - startDay);
      const endDay = end.getUTCDay();
      const gridEnd = new Date(end);
      gridEnd.setUTCDate(end.getUTCDate() + (6 - endDay));
      const totalDays = Math.round((gridEnd - gridStart) / 86400000) + 1;

      for (let i = 0; i < totalDays; i++) {
        const date = new Date(gridStart);
        date.setUTCDate(gridStart.getUTCDate() + i);
        const dateStr = date.toISOString().slice(0, 10);
        const inYear = date >= start && date <= end;
        const count = inYear && commitMap.has(dateStr) ? commitMap.get(dateStr).length : 0;
        const originCounts = originCountByDate.get(dateStr) || new Map();
        const gmuCount = originCounts.get('GMU') || 0;
        const userCount = originCounts.get('Nastajus') || 0;
        const levelBase = count;
        const cell = document.createElement('div');
        cell.className = 'day-cell';
        cell.dataset.date = dateStr;
        cell.title = `${dateStr}: ${count} commit${count === 1 ? '' : 's'}`;
        if (!inYear) {
          cell.classList.add('outside');
        } else if (levelBase > 0) {
          cell.classList.add('level-' + levelFor(levelBase));
          if (gmuCount > 0) {
            cell.classList.add('gmu');
          }
        }
        if (inYear) {
          cell.addEventListener('click', (event) => {
            event.stopPropagation();
            renderDetails(dateStr);
            setDayFocus(dateStr);
            showDayPopup(cell, dateStr);
          });
          cell.addEventListener('mouseenter', (event) => {
            if (currentRepoFilter || currentOriginFilter || dayFocus) return;
            const dateProjects = Array.from(repoByDate.get(dateStr) || []);
            if (dateProjects.length === 0) return;
            const countText = `${dateStr}: ${count} commit${count === 1 ? '' : 's'}`;
            const list = dateProjects.sort().map((p) => `<li>${p}</li>`).join('');
            tooltip.innerHTML = `<div>${countText}</div><ul>${list}</ul>`;
            tooltip.classList.add('visible');
            tooltip.style.top = `${event.pageY + 12}px`;
            tooltip.style.left = `${event.pageX + 12}px`;
          });
          cell.addEventListener('mousemove', (event) => {
            if (!tooltip.classList.contains('visible')) return;
            tooltip.style.top = `${event.pageY + 12}px`;
            tooltip.style.left = `${event.pageX + 12}px`;
          });
          cell.addEventListener('mouseleave', () => {
            tooltip.classList.remove('visible');
          });
        }
        grid.appendChild(cell);
      }

      container.appendChild(header);
      container.appendChild(grid);
      return container;
    }

    function renderHeatmap() {
      const years = new Set();
      for (const key of commitMap.keys()) {
        years.add(parseInt(key.slice(0, 4), 10));
      }
      const sorted = Array.from(years).sort((a, b) => a - b);
      heatmapContainer.innerHTML = '';

      if (!sorted.length) {
        const empty = document.createElement('div');
        empty.textContent = 'No commits found.';
        heatmapContainer.appendChild(empty);
        return;
      }

      for (const year of sorted) {
        heatmapContainer.appendChild(buildYearBlock(year));
      }
    }

    function renderDetails(dateStr, repoFilter = null) {
      const list = commitMap.get(dateStr) || [];
      const filteredList = repoFilter ? list.filter((item) => item.repo_name === repoFilter) : list;
      const title = document.getElementById('detail-title');
      const meta = document.getElementById('detail-meta');
      const container = document.getElementById('commit-list');
      currentDateStr = dateStr;
      title.textContent = dateStr;

      if (!list.length) {
        meta.textContent = '0 commits';
        container.textContent = 'No commits on this day.';
        return;
      }

      if (repoFilter && filteredList.length === 0) {
        meta.textContent = `0 commits for ${repoFilter}`;
        container.textContent = 'No commits for that project on this day.';
        return;
      }

      const sorted = [...filteredList].sort((a, b) => a.commit_date.localeCompare(b.commit_date));

      const repoCount = new Set(sorted.map(item => item.repo_name)).size;
      if (repoFilter) {
        meta.textContent = `${sorted.length} commit${sorted.length === 1 ? '' : 's'} for ${repoFilter}`;
      } else {
        meta.textContent = `${list.length} commit${list.length === 1 ? '' : 's'} across ${repoCount} repo${repoCount === 1 ? '' : 's'}`;
      }
      container.innerHTML = '';

      let currentRepo = null;
      let group = null;

      for (const item of sorted) {
        if (item.repo_name !== currentRepo) {
          currentRepo = item.repo_name;
          group = document.createElement('div');
          group.className = 'repo-group';

          const header = document.createElement('div');
          header.className = 'repo-title';
          const name = document.createElement('button');
          name.type = 'button';
          name.className = 'repo-filter';
          name.textContent = item.repo_name;
          name.addEventListener('click', () => applyRepoFilter(item.repo_name));
          header.appendChild(name);

          if (item.repo_is_private) {
            const tag = document.createElement('span');
            tag.className = 'tag private';
            tag.textContent = 'Private';
            header.appendChild(tag);
          }

          const links = document.createElement('div');
          links.className = 'repo-links';
          const remote = document.createElement('a');
          remote.href = item.repo_remote_url;
          remote.textContent = 'Remote';
          remote.target = '_blank';
          const local = document.createElement('a');
          local.href = item.repo_local_path + '/';
          local.textContent = 'Local';
          links.appendChild(remote);
          links.appendChild(local);

          group.appendChild(header);
          group.appendChild(links);
          container.appendChild(group);
        }

        const row = document.createElement('div');
        row.className = 'commit-item';

        const subject = document.createElement('a');
        subject.className = 'commit-subject';
        subject.textContent = item.commit_subject || '(no subject)';
        subject.href = `${item.repo_remote_url}/commit/${item.commit_hash}`;
        subject.target = '_blank';

        const metaLine = document.createElement('div');
        metaLine.className = 'commit-meta';
        const time = item.commit_date ? item.commit_date.replace('T', ' ').replace('Z', ' UTC') : '';
        metaLine.textContent = `${time}`;

        row.appendChild(subject);
        row.appendChild(metaLine);

        const bodyText = (item.commit_body || '').trim();
        if (bodyText) {
          const body = document.createElement('div');
          body.className = 'commit-body';
          body.textContent = bodyText;
          body.title = 'Click to expand';
          body.addEventListener('click', () => {
            body.classList.toggle('expanded');
          });
          row.appendChild(body);
        }

        group.appendChild(row);
      }
    }

    function renderRepos() {
      const grid = document.getElementById('repo-grid');
      const forkGrid = document.getElementById('fork-grid');
      grid.innerHTML = '';
      forkGrid.innerHTML = '';

      const primary = repos.filter(repo => !repo.is_fork);
      const forks = repos.filter(repo => repo.is_fork);

      const sorted = [...primary].sort((a, b) => {
        if (a.is_private && !b.is_private) return 1;
        if (!a.is_private && b.is_private) return -1;
        return a.name.localeCompare(b.name);
      });

      const sortedForks = [...forks].sort((a, b) => a.name.localeCompare(b.name));

      for (const repo of sorted) {
        const card = document.createElement('div');
        card.className = 'repo-card stagger';
        card.dataset.origin = repo.origin_label;
        const title = document.createElement('h3');
        const titleLine = document.createElement('div');
        titleLine.className = 'repo-title-line';
        const titleButton = document.createElement('button');
        titleButton.type = 'button';
        titleButton.className = 'repo-filter';
        titleButton.textContent = repo.origin_label === 'GMU' ? `GMU / ${repo.name}` : repo.name;
        titleButton.addEventListener('click', () => applyRepoFilter(repo.name));
        const origin = document.createElement('span');
        origin.className = `origin-label ${repo.origin_label === 'GMU' ? 'gmu' : 'user'}`;
        origin.textContent = repo.origin_label;
        origin.addEventListener('click', (event) => {
          event.stopPropagation();
          applyOriginFilter(repo.origin_label);
        });
        titleLine.appendChild(titleButton);
        titleLine.appendChild(origin);
        title.appendChild(titleLine);
        const meta = document.createElement('div');
        meta.className = 'commit-meta';
        const sizeParts = [];
        if (repo.repo_size_kb !== null && repo.repo_size_kb !== undefined) {
          sizeParts.push(`GitHub: ${repo.repo_size_kb} KB`);
        }
        if (repo.local_size_bytes !== null && repo.local_size_bytes !== undefined) {
          const mb = (repo.local_size_bytes / (1024 * 1024)).toFixed(2);
          sizeParts.push(`Local: ${mb} MB`);
        }
        meta.textContent = sizeParts.join(' | ');

        const links = document.createElement('div');
        links.className = 'repo-links';
        const remote = document.createElement('a');
        remote.href = repo.remote_url;
        remote.textContent = 'Remote';
        remote.target = '_blank';
        const local = document.createElement('a');
        local.href = repo.local_path + '/';
        local.textContent = 'Local';
        links.appendChild(remote);
        links.appendChild(local);
        if (repo.is_private) {
          const tag = document.createElement('span');
          tag.className = 'tag private';
          tag.textContent = 'Private';
          links.appendChild(tag);
        }

        card.appendChild(title);
        card.appendChild(meta);
        card.appendChild(links);
        grid.appendChild(card);
      }

      for (const repo of sortedForks) {
        const card = document.createElement('div');
        card.className = 'repo-card stagger';
        card.dataset.origin = repo.origin_label;
        const title = document.createElement('h3');
        const titleLine = document.createElement('div');
        titleLine.className = 'repo-title-line';
        const titleButton = document.createElement('button');
        titleButton.type = 'button';
        titleButton.className = 'repo-filter';
        titleButton.textContent = repo.origin_label === 'GMU' ? `GMU / ${repo.name}` : repo.name;
        titleButton.addEventListener('click', () => applyRepoFilter(repo.name));
        const origin = document.createElement('span');
        origin.className = `origin-label ${repo.origin_label === 'GMU' ? 'gmu' : 'user'}`;
        origin.textContent = repo.origin_label;
        origin.addEventListener('click', (event) => {
          event.stopPropagation();
          applyOriginFilter(repo.origin_label);
        });
        titleLine.appendChild(titleButton);
        titleLine.appendChild(origin);
        title.appendChild(titleLine);
        const meta = document.createElement('div');
        meta.className = 'commit-meta';
        const sizeParts = [];
        if (repo.repo_size_kb !== null && repo.repo_size_kb !== undefined) {
          sizeParts.push(`GitHub: ${repo.repo_size_kb} KB`);
        }
        if (repo.local_size_bytes !== null && repo.local_size_bytes !== undefined) {
          const mb = (repo.local_size_bytes / (1024 * 1024)).toFixed(2);
          sizeParts.push(`Local: ${mb} MB`);
        }
        meta.textContent = sizeParts.join(' | ');

        const links = document.createElement('div');
        links.className = 'repo-links';
        const remote = document.createElement('a');
        remote.href = repo.remote_url;
        remote.textContent = 'Remote';
        remote.target = '_blank';
        const local = document.createElement('a');
        local.href = repo.local_path + '/';
        local.textContent = 'Local';
        links.appendChild(remote);
        links.appendChild(local);
        if (repo.is_private) {
          const tag = document.createElement('span');
          tag.className = 'tag private';
          tag.textContent = 'Private';
          links.appendChild(tag);
        }

        card.appendChild(title);
        card.appendChild(meta);
        card.appendChild(links);
        forkGrid.appendChild(card);
      }
    }

    renderHeatmap();
    renderRepos();

    filterClear.addEventListener('click', () => {
      clearRepoFilter();
      clearOriginFilter();
    });

    const ranges = getLevelRanges();
    const scaleInfo = document.getElementById('scale-info');
    if (scaleInfo && ranges.length) {
      const parts = ranges.map((r) => `L${r.level}: ${r.min}-${r.max}`).join(' | ');
      scaleInfo.textContent = `Current scale (max daily commits = ${maxCount}): ${parts}`;
    }

    document.addEventListener('click', (event) => {
      if (!dayFocus) return;
      if (event.target.closest('#day-popup')) return;
      if (event.target.classList.contains('day-cell')) return;
      if (event.target.closest('.repo-filter')) return;
      clearDayFocus();
    });

    document.getElementById('detail-title').addEventListener('click', (event) => {
      if (!currentDateStr) return;
      event.preventDefault();
      const year = currentDateStr.slice(0, 4);
      const yearBlock = document.querySelector(`.year-block[data-year='${year}']`);
      if (yearBlock) {
        yearBlock.scrollIntoView({ behavior: 'smooth', block: 'center' });
      } else {
        document.getElementById('heatmap').scrollIntoView({ behavior: 'smooth' });
      }
      const cell = document.querySelector(`.day-cell[data-date='${currentDateStr}']`);
      if (cell) {
        cell.classList.remove('flash');
        void cell.offsetWidth;
        cell.classList.add('flash');
      }
    });
  </script>
</body>
</html>
